// SPDX-License-Identifier: SEL-1.0
// Copyright © 2025 Veda Tech Labs
// Derived from Boring Vault Software © 2025 Veda Tech Labs (TEST ONLY – NO COMMERCIAL USE)
// Licensed under Software Evaluation License, Version 1.0
pragma solidity 0.8.21;

import {BaseTestIntegration} from "test/integrations/BaseTestIntegration.t.sol";
import {ERC20} from "@solmate/tokens/ERC20.sol";
import {BTCKDecoderAndSanitizer} from "src/base/DecodersAndSanitizers/Protocols/BTCKDecoderAndSanitizer.sol";
import {BaseDecoderAndSanitizer} from "src/base/DecodersAndSanitizers/BaseDecoderAndSanitizer.sol";
import {Test, stdStorage, StdStorage, stdError, console} from "@forge-std/Test.sol";

contract FullBTCKDecoderAndSanitizer is BTCKDecoderAndSanitizer, BaseDecoderAndSanitizer {}

contract BTCKIntegration is BaseTestIntegration {
    function _setUpKatana() internal {
        super.setUp();
        _setupChain("katana", 7426189);

        address btckDecoder = address(new FullBTCKDecoderAndSanitizer());

        _overrideDecoder(btckDecoder);
    }

    function testBTCKFunctions() external {
        _setUpKatana();

        deal(getAddress(sourceChain, "LBTC"), address(boringVault), 100e8);

        ManageLeaf[] memory leafs = new ManageLeaf[](4);

        //=== BTCK Leafs ===
        _addBTCKLeafs(leafs);

        bytes32[][] memory manageTree = _generateMerkleTree(leafs);

        _generateTestLeafs(leafs, manageTree);

        manager.setManageRoot(address(this), manageTree[manageTree.length - 1][0]);

        Tx memory tx_ = _getTxArrays(2);

        tx_.manageLeafs[0] = leafs[2]; //redeem LBTC
        tx_.manageLeafs[1] = leafs[3]; //mintV1

        bytes32[][] memory manageProofs = _getProofsUsingTree(tx_.manageLeafs, manageTree);

        tx_.targets[0] = getAddress(sourceChain, "LBTC"); //redeem
        tx_.targets[1] = getAddress(sourceChain, "BTCK"); //mintV1

        tx_.targetData[0] = abi.encodeWithSignature("redeem(uint256)", 10e8);
        tx_.targetData[1] = abi.encodeWithSignature(
            "mintV1(bytes,bytes)",
            hex"ce25e7c200000000000000000000000000000000000000000000000000000000000b67d2000000000000000000000000698febaaa34ce7f61858b03f0668fc461d7cc6730000000000000000000000000000000000000000000000000000000000016f3084e2fc0e2de104e836c6c76e1d77b9859f3cf817c31827c1a06ef7bc060ac9bc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b0f70c0bd6fd87dbeb7c10dc692a2a6106817072",
            hex"000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000005c00000000000000000000000000000000000000000000000000000000000000620000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000006e0000000000000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040389cde730d05bb52077a1d45b33e686221aebae8ac249fc5090a928e674c9eef4c2fa4dfa2c120daefc8741e24eb10436e23f905bfe680f42b997189fb4d2beb0000000000000000000000000000000000000000000000000000000000000040b65a7d780941302aaa8cc231d2404124b4f8bd054006a2bd885ac8a767a1ca6d1c087133d49b99b9d204d0eb1e4e41e09a2ebc91b6061732c2505987463055550000000000000000000000000000000000000000000000000000000000000040ec5b52f0a8ea26dbacd931a968343f0ccdeb610ea9b6d339de5ae254aba757a31de05318e566d5ea1587d4d7c9b526ec3c31485a02f751fa680ff145d7fa147400000000000000000000000000000000000000000000000000000000000000401ee039583531f5dd0093d39d4b2bc75b5c6c914b8ceb54ffb5782b2a31eb70a45c337d741878f2e8691283b1412a373772b88857371e4dea79e1fb2482e2f6b4000000000000000000000000000000000000000000000000000000000000004006fd341f9d01e45898c42a1933db52c90b6f0406b5bfcd737e040b5fd870715e7625646d9b76049fa5e60045578783189ca902e24a9e2098db8d5b26b32475be0000000000000000000000000000000000000000000000000000000000000040e8ccda7d9ba405df95a144b969451daccad362bbe73afa1b5d99f30b5dd6d97f578b7ccadc6d5d961eaf8f18802eec948c5550350b49b2c0209364f0e0f86e2e00000000000000000000000000000000000000000000000000000000000000403fd97f56f00ba7e671092f5551b14f63897f84f01317d027c417f53dd31623b76aeebcc4f8f7d1460beeb20a2d9106d279ca8de144a89ae159de7091c177fc920000000000000000000000000000000000000000000000000000000000000040d0ce3bd43fa5f2fc1520b424b58db443556aec67ee83232d75538d99ef276fe31df15570e00936cfcbdffa61d01ffcc6570be29f60b8c1dcc74ba7421c608b6b0000000000000000000000000000000000000000000000000000000000000040eb5e3e00aad176a261ff8c9b64265ee1ed1832b6d7930e5b4feba33ee98259b90ad9b71bcd35dacf699e2e0f250d634e82b66b7388881fc190d17137b4d7ed0b0000000000000000000000000000000000000000000000000000000000000040076abf1b7b303ce1aeba8aa06c74cd2e4b430d057ebedc31f511d8a6272445ae647207a5a9d524dfa915589df0d1c7a4bf8351ea299ae5d799989c46c30e55c600000000000000000000000000000000000000000000000000000000000000401f9b6c30cf4a8d59e74ec9c1daa6e4d463ff156337a9164c3f78c3e5c82d3bb527c9f11d603a9b5ec2969cc0c9e9974e9733f4f1bdec6806c1646436324c11d400000000000000000000000000000000000000000000000000000000000000401c39a969f0c8da423dfee24b041617d30dc75d9104d88dffa741841b57b0ff977a3732e132358d8af3622666d5947fd9347f9d41a437a002cd646b3fad654b56000000000000000000000000000000000000000000000000000000000000004038ddf29ee598a1d5009087ab4e3a2e324691dcbe928d7880a5e786b4f4791446061fb457accb1b2e33431d947971575a658de44b94bb5638ae100964b04d14f500000000000000000000000000000000000000000000000000000000000000406f79c92576c3fd68c1a1f3551fdc3cf75d69d32a1d2c63b67b990b80a5f7908527bba831951d59111ababb0cde881affec54bf040b126e7fed238faa165c27920000000000000000000000000000000000000000000000000000000000000040332291e9facb5414a2e416b717ceed1ab0be294b888b359efdde398c5dc322c74e42f5a459ad8550b32efc108faf1ba3f6fbccd15bfba6618f4c4dc463ce6fbd"
        );

        tx_.decodersAndSanitizers[0] = rawDataDecoderAndSanitizer;
        tx_.decodersAndSanitizers[1] = rawDataDecoderAndSanitizer;

        _submitManagerCall(manageProofs, tx_);

        address receiver = 0x698fEBAaa34CE7F61858B03f0668fC461D7cc673;
        uint256 btckBalance = getERC20(sourceChain, "BTCK").balanceOf(receiver);
        assertGt(btckBalance, 0);
    }

    function testBTCKMintFunction() external {
        _setUpKatana();

        deal(getAddress(sourceChain, "LBTC"), address(boringVault), 100e8);
        deal(getAddress(sourceChain, "BTCK"), address(boringVault), 100e8);

        ManageLeaf[] memory leafs = new ManageLeaf[](4);

        //=== BTCK Leafs ===
        _addBTCKLeafs(leafs);

        bytes32[][] memory manageTree = _generateMerkleTree(leafs);

        _generateTestLeafs(leafs, manageTree);

        manager.setManageRoot(address(this), manageTree[manageTree.length - 1][0]);

        Tx memory tx_ = _getTxArrays(1);

        tx_.manageLeafs[0] = leafs[0]; //depoist BTCK

        bytes32[][] memory manageProofs = _getProofsUsingTree(tx_.manageLeafs, manageTree);

        tx_.targets[0] = getAddress(sourceChain, "LBTC"); //depoist

        tx_.targetData[0] = abi.encodeWithSignature("deposit(uint256)", 10e8);

        tx_.decodersAndSanitizers[0] = rawDataDecoderAndSanitizer;

        _submitManagerCall(manageProofs, tx_);

        uint256 btckBalance = getERC20(sourceChain, "BTCK").balanceOf(address(boringVault));
        assertLt(btckBalance, 100e8);
    }
}
